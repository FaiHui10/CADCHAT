# CADChat 客户端用户手册

## 目录

1. [简介](#简介)
2. [系统要求](#系统要求)
3. [安装与配置](#安装与配置)
4. [快速开始](#快速开始)
5. [功能说明](#功能说明)
6. [使用指南](#使用指南)
7. [常见问题](#常见问题)
8. [故障排除](#故障排除)

---

## 简介

CADChat 是一个智能 CAD 助手客户端，通过自然语言与 AutoCAD 或中望 CAD 进行交互。客户端连接到本地服务器，使用 RAG（检索增强生成）技术进行语义匹配，提供快速、准确的 CAD 命令和代码生成服务。

### 主要功能

- **自然语言交互**：使用中文描述需求，自动匹配 CAD 命令或生成 LISP 代码
- **向量语义检索**：使用 bge-m3 嵌入模型进行高效的语义检索
- **智能匹配**：优先匹配 AutoCAD 基本命令库，提高响应速度
- **LLM 语义理解**：使用 Qwen3 1.7B 模型进行语义匹配，理解复杂需求
- **代码生成**：对于复杂需求，自动生成 LISP 代码
- **实时连接**：实时连接到 CAD 软件，直接执行命令
- **用户代码管理**：支持保存和检索用户自定义的 LISP 程序
- **日志记录**：完整的操作日志，方便追踪和调试

---

## 系统要求

### 硬件要求

- **操作系统**：Windows 10/11
- **处理器**：Intel Core i5 或同等性能处理器
- **内存**：8GB RAM（推荐 16GB）
- **硬盘**：至少 1GB 可用空间
- **网络**：本地网络连接（用于连接服务器）

### 软件要求

- **Python**：3.8 或更高版本
- **CAD 软件**：AutoCAD 2010 或更高版本，或中望 CAD 2010 或更高版本
- **浏览器**：Chrome、Edge 或 Firefox（用于 Kimi 浏览器功能）

### 依赖库

```
tkinter
requests
```

---

## 安装与配置

### 步骤 1：安装 Python

1. 访问 [Python 官网](https://www.python.org/downloads/)
2. 下载并安装 Python 3.8 或更高版本
3. 安装时勾选 "Add Python to PATH"

### 步骤 2：安装依赖

打开命令提示符（CMD）或 PowerShell，执行：

```powershell
pip install requests
```

### 步骤 3：启动服务器

根据部署需求选择相应服务器：

#### 选择一：局域网服务器（本地RAG）

适用于内网环境或对数据安全要求较高的场景。
注意：此部署方式不使用Docker，直接运行Python脚本。

```powershell
cd server
start_server_rag.bat
```

#### 选择二：阿里云服务器（百炼平台）

适用于云端部署或无高性能硬件的场景。
此部署方式支持Docker容器化部署。

```powershell
cd aliserver
start_server_bailian.bat
```

### 步骤 4：配置客户端

1. **复制配置文件**
   ```powershell
   copy .env.example .env
   ```

2. **编辑配置文件**
   ```powershell
   # 编辑 .env 文件，设置服务端URL
   notepad .env
   ```
   
   修改服务端URL配置：
   ```env
   CADCHAT_SERVER_URL=http://localhost:5000  # 本地测试
   # 或
   CADCHAT_SERVER_URL=http://your-ecs-ip:5000  # ECS部署后
   ```

### 步骤 5：启动客户端

```powershell
# 方法1：使用批处理脚本
start_client_updated.bat

# 方法2：直接运行Python脚本
python main_gui_cloud.py
```

---

## 快速开始

### 第一次使用

1. **启动 CAD 软件**
   - 打开 AutoCAD 或中望 CAD
   - 确保软件正常运行

2. **启动服务器**
   - 双击 `server/start_server_rag.bat`
   - 等待服务器启动完成

3. **启动客户端**
   - 双击 `main_gui_cloud.py`（或使用 Python 运行）
   - 客户端窗口将打开

4. **连接 CAD**
   - 点击【连接 CAD】按钮
   - 等待连接成功提示

5. **输入需求**
   - 在"功能需求"输入框中输入需求
   - 例如："画圆"
   - 点击【查询】按钮

6. **执行命令**
   - 查看匹配结果
   - 如果是基本命令，直接在 CAD 中执行

### 停止服务

使用完成后，关闭所有服务：

```powershell
server/stop_server.bat
```

或在任务管理器中手动关闭 Python 进程。

---

## 功能说明

### 主界面

客户端主界面包含以下部分：

#### 1. 状态栏

- **CAD 状态**：显示 CAD 连接状态（已连接/未连接）
- **服务器状态**：显示服务器连接状态（已连接/未连接）
- **浏览器状态**：显示 Kimi 浏览器状态（就绪/未就绪）

#### 2. 功能需求输入区

- **输入框**：输入自然语言需求
- **查询按钮**：查询匹配的命令或代码
- **连接 CAD 按钮**：连接到 CAD 软件
- **断开 CAD 按钮**：断开 CAD 连接

#### 3. 匹配结果显示区

- **匹配结果**：显示匹配的命令或代码信息
- **置信度**：显示匹配的置信度
- **匹配方式**：显示匹配方式（基本命令库/关键词/LLM）

#### 4. 生成的 LISP 代码区

- **代码显示**：显示生成的 LISP 代码
- **执行代码按钮**：在 CAD 中执行代码
- **保存代码按钮**：保存代码到文件

#### 5. 运行日志区

- **日志显示**：显示操作日志和错误信息
- **提交反馈按钮**：提交使用反馈

---

## 使用指南

### 基本命令使用

#### 示例 1：创建圆

**输入**：
```
画圆
```

**输出**：
```
✓ 找到基础命令
  命令: CIRCLE
  别名: C
  描述: 绘制圆
  分类: 基本命令
```

**操作**：
- 在 AutoCAD 中输入 `C` 或 `CIRCLE`
- 按照提示操作

#### 示例 2：创建矩形

**输入**：
```
画矩形
```

**输出**：
```
✓ 找到基础命令
  命令: RECTANG
  别名: REC
  描述: 绘制矩形
  分类: 基本命令
```

**操作**：
- 在 AutoCAD 中输入 `REC` 或 `RECTANG`
- 按照提示操作

#### 示例 3：删除对象

**输入**：
```
删除
```

**输出**：
```
✓ 找到基础命令
  命令: ERASE
  别名: E
  描述: 删除对象
  分类: 基本命令
```

**操作**：
- 在 AutoCAD 中输入 `E` 或 `ERASE`
- 选择要删除的对象

### LISP 代码使用

#### 示例 1：批量修改圆的半径

**输入**：
```
批量修改所有圆的半径为10
```

**输出**：
```
✓ 找到匹配代码（置信度: 0.90）
  描述: 批量修改所有圆的半径
  使用次数: 5
  成功率: 85.00%
  匹配方式: Qwen LLM
```

**代码**：
```lisp
(defun c:modify-circles ()
  (setq radius 10)
  (setq ss (ssget "X" '((0 . "CIRCLE"))))
  (setq i 0)
  (repeat (sslength ss)
    (setq ent (ssname ss i))
    (setq ent_data (entget ent))
    (setq ent_data (subst (cons 40 radius) (assoc 40 ent_data) ent_data))
    (entmod ent_data)
    (setq i (1+ i))
  )
  (princ (strcat "\n已修改 " (itoa (sslength ss)) " 个圆的半径为 " (itoa radius)))
  (princ)
)
```

**操作**：
- 点击【执行代码】按钮
- 代码将自动在 CAD 中执行

#### 示例 2：删除所有红色直线

**输入**：
```
删除所有红色的直线
```

**输出**：
```
✓ 找到匹配代码（置信度: 0.88）
  描述: 删除所有红色直线
  使用次数: 3
  成功率: 90.00%
  匹配方式: Qwen LLM
```

**代码**：
```lisp
(defun c:delete-red-lines ()
  (setq ss (ssget "X" '((0 . "LINE") (62 . 1))))
  (if ss
    (progn
      (command "_.ERASE" ss "")
      (princ (strcat "\n已删除 " (itoa (sslength ss)) " 条红色直线"))
    )
    (princ "\n未找到红色直线")
  )
  (princ)
)
```

**操作**：
- 点击【执行代码】按钮
- 代码将自动在 CAD 中执行

### 连接 CAD

#### 连接到 AutoCAD

1. 确保 AutoCAD 正在运行
2. 点击【连接 CAD】按钮
3. 等待连接成功提示
4. 状态栏显示"已连接 - AutoCAD"

#### 连接到中望 CAD

1. 确保中望 CAD 正在运行
2. 点击【连接 CAD】按钮
3. 等待连接成功提示
4. 状态栏显示"已连接 - ZWCAD"

#### 断开 CAD 连接

1. 点击【断开 CAD】按钮
2. 状态栏显示"未连接"

### 保存代码

#### 保存到临时文件

1. 查询成功后，代码会自动保存到临时文件
2. 临时文件位于：`temp/`
3. 文件名格式：`cadchat_temp_<timestamp>.lsp`

#### 手动保存代码

1. 在"生成的 LISP 代码"区域查看代码
2. 点击【保存代码】按钮
3. 选择保存位置
4. 输入文件名
5. 点击【保存】

---

## 常见问题

### Q1: 客户端无法连接到服务器

**A**:
1. 检查服务器是否正在运行
2. 检查服务器地址是否正确（默认：http://localhost:5000）
3. 检查防火墙设置
4. 尝试重启服务器

### Q2: 客户端无法连接到 CAD

**A**:
1. 确保 CAD 软件正在运行
2. 确保 CAD 软件已完全加载
3. 尝试重启 CAD 软件
4. 检查 CAD 版本是否支持

### Q3: 查询没有匹配结果

**A**:
1. 检查需求描述是否清晰
2. 尝试使用更详细的需求描述
3. 检查基本命令库是否包含相关命令
4. 尝试使用同义词或不同的表达方式

### Q4: LISP 代码执行失败

**A**:
1. 检查代码语法是否正确
2. 检查 CAD 是否支持该代码
3. 查看运行日志中的错误信息
4. 尝试手动在 CAD 中执行代码

### Q5: 如何添加自定义命令？

**A**:
1. 编辑 `server/autocad_basic_commands.txt`
2. 在文件末尾添加新命令
3. 格式：`命令名称|描述|快捷键|命令类型`
4. 重启服务器使更改生效

---

## 故障排除

### 问题 1: 客户端启动失败

**症状**：运行 `python main_gui_cloud.py` 时报错

**可能原因**：
- Python 版本过低
- 缺少依赖库
- 文件路径错误

**解决方法**：
1. 检查 Python 版本：`python --version`
2. 安装依赖：`pip install requests`
3. 确认文件路径正确

### 问题 2: 连接服务器失败

**症状**：状态栏显示"未连接"

**可能原因**：
- 服务器未启动
- 网络连接问题
- 防火墙阻止

**解决方法**：
1. 检查服务器是否正在运行
2. 检查网络连接
3. 添加防火墙例外
4. 重启服务器

### 问题 3: 连接 CAD 失败

**症状**：点击【连接 CAD】后显示"未找到正在运行的CAD程序"

**可能原因**：
- CAD 软件未运行
- CAD 版本不支持
- 权限问题

**解决方法**：
1. 确保 CAD 软件正在运行
2. 检查 CAD 版本
3. 以管理员身份运行客户端

### 问题 4: 代码执行失败

**症状**：点击【执行代码】后报错

**可能原因**：
- 代码语法错误
- CAD 不支持该功能
- 权限问题

**解决方法**：
1. 检查代码语法
2. 查看 CAD 错误信息
3. 以管理员身份运行客户端

### 问题 5: 查询速度慢

**症状**：查询需要很长时间

**可能原因**：
- 服务器性能不足
- 网络延迟
- LLM 模型加载

**解决方法**：
1. 检查服务器性能
2. 优化网络连接
3. 使用基本命令库（优先匹配）

---

## 高级功能

### 自定义命令说明

用户可以在客户端保存自定义的 LISP 代码，服务会自动建立索引方便检索。

### 查看日志

1. 在"运行日志"区域查看操作日志
2. 日志包含时间戳、级别和消息
3. 可以帮助诊断问题

---

## 更新日志

### v0.11 (2026-02-20)
- 相对路径支持，便于局域网部署
- 环境变量配置服务器地址
- 自动检测 Ollama 安装路径

### v0.1 (2026-02-19)
- RAG 向量检索功能
- bge-m3 嵌入模型
- 支持基本命令、LISP命令、用户代码三种来源
- 自动文件监控与缓存重建
- 并发客户端支持
- 用户代码保存与检索
- 界面优化：紧凑布局
---

## 技术支持

如有问题，请联系技术支持或查看在线文档。


